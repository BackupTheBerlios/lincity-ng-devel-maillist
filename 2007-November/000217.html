<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Lincity-ng-devel] [Bug #12472] Lincity Dies on Startup...
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/lincity-ng-devel/2007-November/index.html" >
   <LINK REL="made" HREF="mailto:lincity-ng-devel%40lists.berlios.de?Subject=Re%3A%20%5BLincity-ng-devel%5D%20%5BBug%20%2312472%5D%20Lincity%20Dies%20on%20Startup...&In-Reply-To=%3C200711190937.lAJ9bLXk013306%40unicorn.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000216.html">
   <LINK REL="Next"  HREF="000218.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Lincity-ng-devel] [Bug #12472] Lincity Dies on Startup...</H1>
    <B>admin at berlios.de</B> 
    <A HREF="mailto:lincity-ng-devel%40lists.berlios.de?Subject=Re%3A%20%5BLincity-ng-devel%5D%20%5BBug%20%2312472%5D%20Lincity%20Dies%20on%20Startup...&In-Reply-To=%3C200711190937.lAJ9bLXk013306%40unicorn.berlios.de%3E"
       TITLE="[Lincity-ng-devel] [Bug #12472] Lincity Dies on Startup...">admin at berlios.de
       </A><BR>
    <I>Mon Nov 19 10:37:21 CET 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="000216.html">[Lincity-ng-devel] [Bug #12472] Lincity Dies on Startup...
</A></li>
        <LI>Next message: <A HREF="000218.html">[Lincity-ng-devel] [Bug #12472] Lincity Dies on Startup...
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#217">[ date ]</a>
              <a href="thread.html#217">[ thread ]</a>
              <a href="subject.html#217">[ subject ]</a>
              <a href="author.html#217">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Bug #12472, was updated on 2007-Nov-19 03:36
Here is a current snapshot of the bug.

Project: LinCityNG
Category: None
Status: Open
Resolution: None
Bug Group: None
Priority: 5
Submitted by: diskman
Assigned to : none
Summary: Lincity Dies on Startup...

Details: When I fireup Lincity-ng it simply quits:


[<A HREF="https://lists.berlios.de/mailman/listinfo/lincity-ng-devel">willi at jericho</A> willi]$ lincity-ng  -m
Starting lincity-ng (version 1.1.1)...
[/home/willi/.lincity] is in the search path.
[/usr/share/lincity-ng] is in the search path.
LINCITY_HOME: /usr/share/lincity-ng
Killed
[<A HREF="https://lists.berlios.de/mailman/listinfo/lincity-ng-devel">willi at jericho</A> willi]$ 

Compiled with the following:
GCC-4.0.1
Jam-2.5
Binutils-2.17


Follow-Ups:

Date: 2007-Nov-19 03:37
By: diskman

Comment:
Here's the debug info generated by GDB/DDD:

/*
Copyright (C) 2005 Wolfgang Becker &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/lincity-ng-devel">uafr at gmx.de</A>&gt;
    
This program is free software; you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation; either version 2 of the License, or
(at your option) any later version.
    
This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.
    
You should have received a copy of the GNU General Public License
along with this program; if not, write to the Free Software
Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
*/
#include &lt;config.h&gt;
    
#include &quot;Sound.hpp&quot;
    
#include &lt;assert.h&gt;
#include &lt;iostream&gt;
#include &lt;sstream&gt;
#include &lt;stdexcept&gt;
    
#include &quot;PhysfsStream/PhysfsSDL.hpp&quot;
    
#include &lt;SDL_mixer.h&gt;
#include &lt;physfs.h&gt;
#include &quot;Config.hpp&quot;
    
    
Sound* soundPtr = 0;
    
Sound *getSound()
{
  return soundPtr;
}
    
int
Sound::soundThread(void* ptr)
{
    Sound* sound = (Sound*) ptr;
    sound-&gt;loadWaves();
    return 0;
}
        
void
Sound::loadWaves() {
    //Load Waves
    std::string filename;
    std::string directory = &quot;sounds/&quot;;
    std::string fullname;
    Mix_Chunk *chunk;
    SDL_RWops* file;
    char **rc = PHYSFS_enumerateFiles( directory.c_str() );
    char **i;
    for (i = rc; *i != NULL; i++) {
        fullname = directory;
        fullname.append( *i );
        filename.assign( *i );
    
        if(PHYSFS_isDirectory(fullname.c_str()))
            continue;
            
        try {        
            file = getPhysfsSDLRWops( fullname.c_str() );
            chunk = Mix_LoadWAV_RW( file, 1);
            if(!chunk) {
                std::stringstream msg;
                msg &lt;&lt; &quot;Couldn't read soundfile '&quot; &lt;&lt; fullname
                    &lt;&lt; &quot;': &quot; &lt;&lt; SDL_GetError();
                throw std::runtime_error(msg.str());
            }
    
            std::string idName = getIdName( filename );
            waves.insert( std::pair&lt;std::string,Mix_Chunk*&gt;(idName, chunk) );
        } catch(std::exception&amp; e) {
            std::cerr &lt;&lt; &quot;Error: &quot; &lt;&lt; e.what() &lt;&lt; &quot;\n&quot;;
        }
    }
    PHYSFS_freeList(rc);
}
    
Sound::Sound()
    : currentMusic(0)
{
    assert( soundPtr == 0);
    soundPtr = this;
    loaderThread = 0;
    
    //Load Sound
    audioOpen = false;
    /* Open the audio device */
    if (Mix_OpenAudio( MIX_DEFAULT_FREQUENCY, MIX_DEFAULT_FORMAT, 2, 2048) &lt; 0) {
        fprintf(stderr, &quot;Couldn't open audio: %s\n&quot;, SDL_GetError());
        return;
    } else {
        audioOpen = true;
        loaderThread = SDL_CreateThread(soundThread, this);
    }
    
    setMusicVolume(getConfig()-&gt;musicVolume);
    setSoundVolume(getConfig()-&gt;soundVolume);
    
    // for now...
    //playMusic(&quot;01 - pronobozo - lincity.ogg&quot;);
    playMusic( getConfig()-&gt;playSongName );
}
    
Sound::~Sound()
{
    //SDL_KillThread( loaderThread );
    SDL_WaitThread( loaderThread, NULL );
    if(currentMusic)
        Mix_FreeMusic(currentMusic);
    
    if( soundPtr == this )
    {
        soundPtr = 0;
    }
    for (chunks_t::iterator i = waves.begin(); i != waves.end(); i++) {
        Mix_FreeChunk( i-&gt;second );
    }
    if ( audioOpen ) {
        Mix_CloseAudio();
        audioOpen = false;
    }
}
    
/*
 *  Playback an Audio-Effect.
 *  Name is the Name of an Audiofile from sounds/ minus .wav
 *  and without trailing Numbers. If there are eg.
 *  beep1.wav, beep2.wav, beep3.wav
 *  playSound( &quot;beep&quot; ) would pick one of the three Files randomly
 */
void
Sound::playSound(const std::string&amp; name) {
    if( !getConfig()-&gt;soundEnabled ){
        return;
    }
    if( !audioOpen ){
        return;
    }
    
    chunks_t::size_type count = waves.count( name );
    if ( count == 0 ) {
        std::cout &lt;&lt; &quot;Couldn't find audio file '&quot; &lt;&lt; name &lt;&lt; &quot;'\n&quot;;
        return;
    }
    
    chunks_t::iterator it = waves.find(name);
    for (int i = rand() % count; i &gt; 0; i--) {
        it++;
    }
    
    Mix_Volume( 0, getConfig()-&gt;soundVolume );
    Mix_PlayChannel( 0, it-&gt;second, 0 ); 
}
    
/*
 * Get ID-String for a given Filename.
 */
std::string
Sound::getIdName(const std::string&amp; filename)
{
    std::string::size_type pos = filename.find_first_of(&quot;.0123456789&quot;);
    
    return filename.substr(0, pos);
}
    
void
Sound::playMusic(const std::string&amp; name)
{
    getConfig()-&gt;playSongName = name;
    if(!audioOpen)
        return;
    
    musicFile = name;
    if(getConfig()-&gt;musicEnabled) {
        if(currentMusic) {
            Mix_FreeMusic(currentMusic);
            currentMusic = 0;
        }
        if(musicFile == &quot;&quot;)
            return;
    
        // transform filename... because the music commands in SDL_Mixer don't
        // support reading callbacks to read from physfs directly
        std::string filename = &quot;music/&quot;;
        filename += name;
        const char* dir = PHYSFS_getRealDir(filename.c_str());
        if(dir == 0) {
            std::cerr &lt;&lt; &quot;Warning couldn't find music file '&quot; &lt;&lt; name &lt;&lt; &quot;'.\n&quot;;
            return;
        }
        filename = dir;
        filename += &quot;/music/&quot;;
        filename += name;
        
        currentMusic = Mix_LoadMUS(filename.c_str());
        if(currentMusic == 0) {
            std::cerr &lt;&lt; &quot;Couldn't load music file '&quot; &lt;&lt; filename &lt;&lt; &quot;': &quot;
                &lt;&lt; SDL_GetError() &lt;&lt; &quot;\n&quot;;
            return;
        }
    
        Mix_PlayMusic(currentMusic, -1);
    }
}
    
void
Sound::enableMusic(bool enabled)
{
    if(getConfig()-&gt;musicEnabled == enabled)
        return;
    getConfig()-&gt;musicEnabled = enabled;
    
    if(!audioOpen)
        return;
    
    if(enabled) {
        playMusic(musicFile);
    } else {
        if(Mix_PlayingMusic()) {
            Mix_FadeOutMusic(1000);
        }
    }
}
    
void
Sound::setMusicVolume(int vol)
{
    if(vol &lt; 0 || vol &gt; 100)
        throw std::runtime_error(&quot;Music volume out of range (0..100)&quot;);
    
    getConfig()-&gt;musicVolume = vol;
    float volvalue = vol * MIX_MAX_VOLUME / 100.0;
    Mix_VolumeMusic(static_cast&lt;int&gt;(volvalue));
}
    
void
Sound::setSoundVolume(int vol)
{
    if(vol &lt; 0 || vol &gt; 100)
        throw std::runtime_error(&quot;Music volume out of range (0..100)&quot;);
    
    getConfig()-&gt;soundVolume = vol;
    float volvalue = vol * MIX_MAX_VOLUME / 100.0;
    Mix_Volume(-1, static_cast&lt;int&gt;(volvalue));
}
    
GNU DDD 3.3.11 (alphapca56-alpha-linux-gnu), by Dorothea L&#252;tkehaus and Andreas Zeller.
Copyright &#169; 1995-1999 Technische Universit&#228;t Braunschweig, Germany.
Copyright &#169; 1999-2001 Universit&#228;t Passau, Germany.
Copyright &#169; 2001 Universit&#228;t des Saarlandes, Germany.
Copyright &#169; 2001-2004 Free Software Foundation, Inc.
(gdb) file /usr/bin/lincity-ng
Using host libthread_db library &quot;/lib/libthread_db.so.1&quot;.
(gdb) run -m
[Thread debugging using libthread_db enabled]
[New Thread 16384 (LWP 3983)]
Starting lincity-ng (version 1.1.1)...
[/home/willi/.lincity] is in the search path.
[/usr/share/lincity-ng] is in the search path.
LINCITY_HOME: /usr/share/lincity-ng
[New Thread 32769 (LWP 3986)]
[New Thread 16386 (LWP 3987)]
[New Thread 32771 (LWP 3988)]

Program received signal SIGSEGV, Segmentation fault.
[Switching to Thread 32771 (LWP 3988)]
0x0000020010099d08 in strcmp () from /lib/libc.so.6.1
(gdb) bt full
#0  0x0000020010099d08 in strcmp () from /lib/libc.so.6.1
No symbol table info available.
#1  0x0000020000678220 in enumFilesCallback () from /usr/lib/libphysfs-1.1.so.0
No symbol table info available.
#2  0x000002000068bdf0 in __PHYSFS_platformEnumerateFiles () from /usr/lib/libphysfs-1.1.so.0
No symbol table info available.
#3  0x00000200006803e0 in DIR_enumerateFiles () from /usr/lib/libphysfs-1.1.so.0
No symbol table info available.
#4  0x000002000067cdf0 in PHYSFS_enumerateFilesCallback () from /usr/lib/libphysfs-1.1.so.0
No symbol table info available.
#5  0x000002000067cfcc in PHYSFS_enumerateFiles () from /usr/lib/libphysfs-1.1.so.0
No symbol table info available.
#6  0x0000000120047d78 in Sound::loadWaves (this=0x120198970) at src/lincity-ng/Sound.cpp:57
        directory = {static npos = 18446744073709551615, _M_dataplus = {&lt;std::allocator&lt;char&gt;&gt; = {&lt;__gnu_cxx::new_allocator&lt;char&gt;&gt; = {&lt;No data fields&gt;}, &lt;No data fields&gt;}, _M_p = 0x120195178 &quot;sounds/&quot;}}
        fullname = {static npos = 18446744073709551615, _M_dataplus = {&lt;std::allocator&lt;char&gt;&gt; = {&lt;__gnu_cxx::new_allocator&lt;char&gt;&gt; = {&lt;No data fields&gt;}, &lt;No data fields&gt;}, _M_p = 0x20000974538 &quot;&quot;}}
        chunk = Variable &quot;chunk&quot; is not available.
(gdb) 

-------------------------------------------------------

For detailed info, follow this link:
<A HREF="http://developer.berlios.de/bugs/?func=detailbug&amp;bug_id=12472&amp;group_id=2929">http://developer.berlios.de/bugs/?func=detailbug&amp;bug_id=12472&amp;group_id=2929</A>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000216.html">[Lincity-ng-devel] [Bug #12472] Lincity Dies on Startup...
</A></li>
	<LI>Next message: <A HREF="000218.html">[Lincity-ng-devel] [Bug #12472] Lincity Dies on Startup...
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#217">[ date ]</a>
              <a href="thread.html#217">[ thread ]</a>
              <a href="subject.html#217">[ subject ]</a>
              <a href="author.html#217">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/lincity-ng-devel">More information about the Lincity-ng-devel
mailing list</a><br>
</body></html>
